# CH2 - 도커의 동작 원리

# 1. 도커의 동작 원리

## 도커의 구조

- 일반적으로 도커와 컨테이너는 서버에서 사용되며, 다음과 같은 구조를 띤다.

![Untitled](https://github.com/shkum0330/TIL/assets/102662024/5193c3d4-96f8-497c-a5f9-6544be224804)

- 물리 서버가 있고, 이 물리 서버에서 동작하는 리눅스 운영체제가 있다.
- 일반적인 서버라면 운영체제 위에 프로그램이나 데이터가 직접 올라가겠지만 도커를 사용하는 경우에는 운영체제 위에서 도커 엔진이 동작하고 그 위에서 컨테이너가 동작한다.
- 프로그램이나 데이터는 컨테이너 안에 위치한다.

### 컨테이너 안에는 운영체제 ‘비슷한 것’이 들어있다.

- 텅 빈 컨테이너는 의외로 잘 사용되지 않는다.
- 모든 컨테이너에는 `리눅스 운영체제 비슷한 무언가`가 들어있다. 빈 컨테이너라고 했지만 정말로 텅 빈 것은 아니다.

### 운영체제가 하는 일은 뭘까?

- 운영체제는 소프트웨어나 프로그램의 명령을 하드웨어에 전달하는 역할을 한다.
- 본래 운영체제는 `커널`이라는 부분과 `그 외의 주변 부분`으로 구성된다.
    - 주변 부분이 프로그램의 연락 내용을 커널에 전달하고 커널이 하드웨어를 다룬다.
- 도커에서는 컨테이너가 완전히 분리되어 있으므로 밑바탕이 되는 리눅스 운영체제의 주변 부분이 컨테이너 속 프로그램의 명령을 전달받을 수 없다.
    - 따라서 컨테이너 속에 운영체제의 주변 부분이 들어 있어 프로그램의 명령을 전달받고 이를 밑바탕이 되는 커널에 전달하는 구조로 되어 있다.
- 리눅스 전체를 컨테이너 속에 넣으면 되지 않을까 싶지만 주변 부분만 컨테이너에 넣고 커널은 밑바탕에 있는 것을 빌려 쓰는 형태 덕분에 도커의 가장 큰 특징인 ‘가벼움’을 얻을 수 있다.

## 도커는 기본적으로 리눅스용이다

- 도커는 밑바탕에서 리눅스 운영체제가 동작하는 것을 전제로 하는 구조로 되어 있기 때문에 리눅스 운영체제에서만 동작할 수 있다.
    - 컨테이너 안에 들어있는 주변 부분도 이에 맞춰 리눅스의 주변 부분이어야 한다.
- 컨테이너에서 실행할 소프트웨어도 역시 리눅스용 소프트웨어이다.
- 즉, 도커는 리눅스 컴퓨터에 독립된 격리 환경을 만드는 것이며, 리눅스에서만 동작하고, 컨테이너에서 동작할 프로그램도 리눅스용 프로그램이다.

### 윈도우와 macOS에서 도커 구동하기

- 도커를 사용하려면 어떤 형태로든 리눅스 운영체제를 갖추어야 한다.
- VirtualBox나 VMware같은 가상환경 위에 리눅스 운영체제를 설치하고 그 위에서 도커를 실행하거나 ‘윈도우용 또는 macOS용 도커 데스크톱’처럼 도커를 실행하는 데 필요한 리눅스 운영체제를 포함한 패키지를 설치해 사용하는 두 가지 경우로 나뉜다.

# 2. 도커 허브와 이미지, 그리고 컨테이너

## 이미지와 컨테이너

- 컨테이너를 생성하려면 먼저 이미지를 만들어야 한다.
- 이미지는 컨테이너의 설계도 역할을 한다.
    - 운영체제나 소프트웨어를 설치할 때 사용되는 ISO 파일과 비슷하다.

### 이미지는 금형과 같다

- 이미지 자체로는 큰 쓸모가 없다.
- 이미지는 컨테이너를 만드는 데 사용한다.
    - 금형과 같은 역할을 하는 것으로, 하나만 있으면 똑같은 것을 여러 개 만들 수 있다.
    - 따라서 동일한 컨테이너를 여러 개 배치하기 편리하다.

### 컨테이너로도 이미지를 만들 수 있다

- 컨테이너로 이미지를 만드는 것은 이미 만든 컨테이너에 손을 대서 컨테이너의 금형을 새로이 만드는 과정이다.
- 컨테이너로부터 이미지를 만들 수 없었다면 여러 개의 컨테이너를 일일이 수정할 수밖에 없었을 것이다.
- 개조된 컨테이너로부터 이미지를 만들고 나면 새로 만든 이미지를 사용해 개조된 컨테이너를 여러 개 만들 수 있다.
    - 소프트웨어나 시스템을 넣은 새로운 이미지를 만들면 다수의 서버를 준비하는 작업이 매우 간단해진다.

### 도커 엔진 간에 이동이 가능하다

- 동일한 컨테이너를 여러 개 만들지 않더라도 이러한 특성을 이용해 다른 물리 서버에 설치된 도커 엔진으로 컨테이너를 이동시킬 수 있다.
    - 다른 서버나 컴퓨터에 도커 엔진을 설치하고 이미지를 이용해 똑같은 컨테이너를 생성하면 된다.

## 도커 허브와 도커 이미지

- 이미지는 주로 ‘도커 허브’에서 구하게 된다. 도커 허브는 공식적으로 운영되는 도커 레지스트리(도커 이미지를 배포하는 서비스)의 이름이다.
- 도커 허브는 구글 플레이 스토어와 비슷한 존재로, 공개된 컨테이너 이미지가 모여있는 곳이다.

### 도커 허브에는 어떤 이미지가 공개되어 있을까?

- 도커 허브에는 운영체제(비슷한 것)만 들어있는 이미지부터, 여러가지 소프트웨어가 함께 포함된 것까지 다양한 이미지가 제공된다.
- 같은 소프트웨어도 다양한 변종의 이미지가 제공된다.
    - 리눅스에는 다양한 배포판이 있는데, 주요 배포판은 모두 이미지로 제공된다. 더 나아가 배포판의 버전마다 운영체제(비슷한 것)만 들어간 컨테이너도 별도로 제공된다
    - 여기에 다시 소프트웨어가 들어가므로 조합의 가짓수는 셀 수 없이 많다.

### 안전한 컨테이너 이미지를 고르는 법

- **공식 이미지를 사용한다.**
    - 다만 컨테이너에 포함된 운영체제(비슷한 것)이 특정 운영체제 및 버전으로 한정된 경우가 있어서 원하는 것을 선택하지 못할 수도 있으므로 꼭 특정 운영체제 및 버전을 사용해야 하는 상황에서는 주의가 필요하다.
- **커스텀 이미지를 직접 만들어 사용한다.**
    - 컨테이너 이미지를 원하는 대로 구성해 커스텀 이미지를 만들 수 있다. 필요한 최소한의 요소가 담긴 이미지에 필요한 소프트웨어를 추가로 설치해 커스텀 이미지를 만든다.
    - 운영체제(비슷한 것)만 들어있는 컨테이너부터 직접 만드는 것은 추천하지 않으나 운영체제가 포함된 이미지에 소프트웨어를 넣는 정도는 그리 어렵지 않다.
    - 다만 경험이 쌓일 때까지는 섣불리 판단하지 말고 신중하게 이미지를 선택해 사용하도록 한다.

### 다양한 형태로 조합이 가능한 컨테이너

- 도커를 사용할 때의 원칙 중 하나로, `한 컨테이너에 한 프로그램`이라는 것이 있다. 보안 및 유지 관리 측면에서 유리하기 때문에 많이 쓰이는 정책이다.
    - 다른 소프트웨어와 독립된 환경을 갖기 때문에 다른 소프트웨어의 영향을 덜 받는다는 특징이 있다. 또, 사이드 이펙트가 적은만큼 업데이트가 쉬워서 유지보수 측면에서도 유리하다.

### 모든 프로그램이 담긴 컨테이너를 만드는 방법

- 컨테이너를 구축하는 방법은 다양하다. 따라서 컨테이너의 구성도 그만큼 다양하지만 그 중에서도 모든 프로그램을 한데 모아 담은 컨테이너는 바로 실행할 수 있어서 자주 쓰인다.

### 운영체제를 한 종류로 통일해야 할까?

- 호스트 컴퓨터와 컨테이너에서 각각 다른 배포판을 사용해도 괜찮은 것일까?
    - 결론부터 말하면 아무 문제가 없다.
    - 애초에 도커를 사용하는 경우에는 컨테이너에 세세한 설정을 하지도 않고, 이미지를 선택할때도 운영체제가 무엇인지도 크게 신경쓰지 않고 그냥 최신 버전을 선택하는 경우가 많다.
- 다만 컨테이너에 로그인할 필요가 있거나 특정 DBMS를 사용할 때는 운영체제 종류에 따라 문제를 일으킬 수 있으므로 배포판을 정확히 선택해야 한다.

# 3. 도커 컨테이너의 생애주기와 데이터 저장

## 도커 컨테이너는 쓰고 버리는 일회용품

- 컨테이너는 쓰고 버리는 일회용품 같은 것이다.
- 컨테이너 하나를 업데이트하면서 계속 사용하기보다는 업데이트된 소프트웨어가 들어있는 새로운 컨테이너를 사용하는 것이 좋다.
    - 즉 새로운 버전이 나오면 새로운 컨테이너로 갈아타는 것이다.
- 이것이 가능한 이유는 컨테이너는 일반적으로 여러 개를 동시 가동하는 상황을 전제로 하기 때문이다.
    - 여러 개의 컨테이너를 하나하나 업데이트하려면 많은 수고가 든다.
    - 유지보수할 때마다 컨테이너를 일일이 업데이트하려니 컨테이너의 장점이 반감된다.
- 컨테이너를 만들고, 실행하고, 종료하고, 폐기한 다음 다시 컨테이너를 만드는 일련의 과정을 `컨테이너의 생애주기` 라고 부른다.

## 데이터 저장

- 컨테이너를 폐기했다면 컨테이너에 들어있던 데이터는 어떻게 될까?
    - 해당 컨테이너 안에서 편집했던 파일은 당연히 사라진다.
- 이런 일을 방지하기 위해 보통은 `도커가 설치된 물리적 서버(호스트)의 디스크를 마운트`해 이 디스크에 데이터를 저장한다.
- **마운트:** 디스크를 연결해 데이터를 기록하도록 한 상태
    - 컴퓨터에 USB나 외장하드를 연결하는 것과 비슷하다.
- 이런 방법으로 컨테이너가 폐기되더라도 데이터는 컨테이너 외부에 안전하게 저장되어 사라지지 않는다.
    - 최악의 경우 도커 엔진 자체에 무슨 일이 생기더라도 데이터는 그대로 보존된다.
- 그리고 데이터를 이렇게 외부에 저장하면 다른 컨테이너와 데이터를 공유할 수도 있어서 매우 편리하다.
- 즉, 운영체제나 소프트웨어 부분은 컨테이너 형태로 만들었다가 쓰고 버리는 것을 반복하고, 데이터는 다른 곳에 저장해두고 같은 것을 계속 사용하는 것이다. 설정 파일도 마찬가지이다.
- 그러나 프로그램을 개발할 때는 다른 저장소에 저장하지 않는 경우도 있으므로 컨테이너를 폐기하기 전에 중요한 데이터가 컨테이너에 포함되어 있는지 확인해야 한다.

# 4. 도커의 장점과 단점

## 도커의 구조와 성질

### ‘환경을 격리할 수 있다’는 것이 핵심이다

- **독립된 환경**
    - 여러 개의 컨테이너를 띄울 수 있으며, 똑같은 앱도 여러 개 띄울 수 있다.
- **이미지를 만들 수 있다**
    - 이미지를 만들 수 있고, 그렇게 만든 이미지를 도커 허브에 배포할 수 있다.
    - 그러므로 모든 이미지를 스스로 처음부터 만들지 않아도 이미지를 내려받기만 하면 컨테이너를 사용할 수 있다.
    - 구축 작업이 간단해지므로 교체와 업데이트가 쉬운 장점이 있다.
    - 이동성이 좋다는 특징으로도 이어진다. 환경 이동이나, 개발환경을 구축하기도 쉽다.
- **컨테이너의 커널을 포함시킬 필요가 없다**
    - 운영체제의 핵심이 되는 부분을 포함시킬 필요가 없으므로 가볍다. 또 배포판도 원하는 것을 사용할 수 있다.

## 서버 관리의 관점에서 도커의 장점과 단점

- 도커의 장점은 **여러 개, 이동성, 생성, 보안**이라는 키워드로 나타낼 수 있다.

### 도커의 장점

- **한 대의 물리 서버에 여러 대의 서버를 띄울 수 있다**
    - 여러 대의 서버를 띄우는 것 자체는 일반적인 서버로도 가능하다. 하지만 도커는 격리된 환경을 제공하므로 이들이 각각 안전한 상태로 실행되며, 일반적인 서버에서는 함께 실행할 수 없는 조합(같은 소프트웨어를 여러 번 실행)도 가능하다.
    - 컨테이너에는 커널이 포함되지 않으므로 물리 서버의 운영체제에 의존한다. 이러한 이유로 소프트웨어적으로 하드웨어를 재현하는 가상화 기술에 비하면 압도적으로 가볍다.
- 서**버 관리가 용이하다**
    - 컨테이너를 이용해 각 소프트웨어를 독립된 환경에 격리하므로 다른 소프트웨어에 영향을 끼치지 않고, 업데이트도 간단하다.
    - 게다가 컨테이너 교체나 수정이 쉬우므로 환경 이전이 간단하다.
- **서버 고수가 아니어도 다루기가 쉽다**
    - 명령 한 줄로 서버 구축이 끝나므로 터미널에 명령을 직접 입력해야 한다는 것 외에는 장애물이 없다

### 도커의 단점

- 리눅스용 소프트웨어밖에 지원하지 않는다.
    - 유닉스도 사용할 수 없고 윈도우 서버는 아예 지원하지 않는다.
- 물리 서버 한 대에 여러 대의 서버를 띄우는 형태이므로 호스트 서버에 문제가 생기면 모든 컨테이너에 영향이 미친다.
    - 이 점은 가상화 기술이나 여러 명의 사용자가 서버를 공유하는 렌탈 서버, 렌탈 클라우드 등의 가상화 플랫폼에서도 마찬가지지만 하나의 물리 서버에 하나의 기능을 띄우는 상태와 비교하면 물리 서버에 문제가 생겼을 때 영향이 미치는 범위가 커진다.
- 컨테이너 하나를 장기간에 걸쳐 사용할 때는 그리 큰 장점을 느끼기 어렵다.
    - 컨테이너를 하나밖에 사용하지 않는다면 도커 엔진이 단순 오버헤드에 지나지 않는다.

## 도커의 주 용도

### 팀원 모두에게 동일한 개발환경 제공하기

- 여러 프로젝트에 동시에 참여하는 현장에서는 프로젝트별로 컨테이너를 따로 사용할 수 있다.
- 컨테이너는 운영환경과 완전히 동일하게 생성되므로 개발환경과 운영환경의 차이가 근본적으로 사라진다.

### 새로운 버전의 테스트

- 운영체제나 라이브러리 등 새로운 버전을 먼저 개발환경에서 테스트한 후 운영환경에 적용할 때도 컨테이너를 활용할 수 있다.
- 컨테이너 형태를 유지하는 한 도커 엔진이 구동을 보장해주므로 물리 서버와의 상성은 고려하지 않아도 된다.
- 새로운 버전뿐만 아니라 변경된 환경에 대한 테스트에도 유용하다.

### 동일한 서버가 여러 대 필요한 경우

- 한 대의 물리 서버에 똑같은 서버를 여러 개 만들 수 있다.
- 명령 한 줄이면 서버를 필요한 만큼 띄울 수 있으므로 운영체제를 설치하고, 로그인한 다음 소프트웨어를 설치하는 단순 업무를 반복할 필요가 없다.
    - 소프트웨어까지 하나로 묶은 패키지를 사용하면 더욱 편리하다.

## 도커에서는 파일이 날아가기 쉬울까? 도커에 대한 오해

- 명시적으로 지우는 경우가 많다.
- 지워지면 안되는 파일은 주의해서 다뤄야 하는 것이지, 파일이 잘 날아가는 것이 아니다. 지울 때가 많은 것이다.
